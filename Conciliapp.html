<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CONCILIABOT - Sistema de Conciliación Bancaria</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap');

        body {
            font-family: 'Roboto', sans-serif;
            background-color: #f4f7f9;
            color: #333;
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .header {
            width: 100%;
            max-width: 1400px;
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        h1 {
            color: #1a237e;
            font-weight: 700;
        }
        .controls-container {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        .file-upload-container {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        input[type="file"] {
            display: none;
        }
        .custom-file-upload, .action-button, .filter-label {
            background-color: #007bff;
            color: white;
            padding: 12px 20px;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s ease;
            font-weight: 500;
            border: none;
            text-align: center;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .custom-file-upload:hover, .action-button:hover, .filter-label:hover {
            background-color: #0056b3;
        }
        .search-filter-container {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        .search-filter-container input[type="text"] {
            padding: 8px;
            border-radius: 4px;
            border: 1px solid #ccc;
        }
        .metrics-container {
            width: 100%;
            max-width: 1400px;
            display: flex;
            justify-content: space-around;
            flex-wrap: wrap;
            margin-bottom: 20px;
            background-color: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        .metric {
            text-align: center;
            padding: 10px 15px;
        }
        .metric h3 {
            margin: 0;
            font-size: 16px;
            color: #555;
        }
        .metric p {
            font-size: 24px;
            font-weight: 700;
            margin: 5px 0 0;
        }
        .tables-container {
            display: flex;
            justify-content: space-between;
            gap: 20px;
            width: 100%;
            max-width: 1400px;
            flex-wrap: wrap;
        }
        .table-wrapper {
            flex: 1;
            min-width: 450px;
            background-color: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            overflow-x: auto;
        }
        h2 {
            color: #4a148c;
            border-bottom: 2px solid #e0e0e0;
            padding-bottom: 10px;
            margin-top: 0;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #ddd;
            font-size: 14px;
        }
        th {
            background-color: #f2f2f2;
            font-weight: 700;
            text-transform: uppercase;
            color: #555;
        }
        tr:hover {
            background-color: #f9f9f9;
        }
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            margin-top: 20px;
        }
        .pagination button {
            background-color: #ccc;
            border: none;
            padding: 8px 12px;
            cursor: pointer;
            border-radius: 4px;
            transition: background-color 0.3s ease;
        }
        .pagination button:hover {
            background-color: #999;
        }
        .pagination button:disabled {
            background-color: #eee;
            cursor: not-allowed;
        }
        .conciliado { background-color: #e6ffe6; } /* Color verde para todo lo punteado */
        .partida-conciliatoria { background-color: #ffe6e6; }
    </style>
</head>
<body>

    <div class="header">
        <h1>CONCILIABOT - Sistema de Conciliación Bancaria</h1>
        <p>Automatización y optimización de tus procesos contables</p>
    </div>

    <div class="controls-container">
        <div class="file-upload-container">
            <label for="libro-file" class="custom-file-upload">Cargar Libro Contable</label>
            <input type="file" id="libro-file" accept=".xlsx, .xls">
            
            <label for="banco-file" class="custom-file-upload">Cargar Movimientos Bancarios</label>
            <input type="file" id="banco-file" accept=".xlsx, .xls">
        </div>
        <button class="action-button" id="auto-match-btn" disabled>Conciliación Automática</button>
        <button class="action-button" id="manual-match-btn" disabled>Conciliar Manualmente</button>
        <button class="action-button" id="download-btn" disabled>Descargar Consolidado</button>
    </div>

    <div class="metrics-container">
        <div class="metric"><p id="total-libro-val">$0</p><h3>Total Libro</h3></div>
        <div class="metric"><p id="total-banco-val">$0</p><h3>Total Banco</h3></div>
        <div class="metric"><p id="total-punteado-val">$0</p><h3>Total Punteado</h3></div>
        <div class="metric"><p id="diferencia-val">$0</p><h3>Diferencia</h3></div>
        <div class="metric"><p id="partidas-val">$0</p><h3>Partidas Pendientes</h3></div>
    </div>

    <div class="tables-container">
        <div class="table-wrapper">
            <h2>Libro Contable</h2>
            <div class="search-filter-container">
                <input type="text" id="libro-search-valor" placeholder="Buscar por Valor">
                <input type="text" id="libro-search-id" placeholder="Buscar por ID">
                <label class="filter-label">
                    <input type="checkbox" id="libro-filter-conciliados"> Filtrar Punteados
                </label>
            </div>
            <div class="pagination" id="libro-pagination">
                <button id="libro-prev-btn" disabled>Anterior</button>
                <span>Página <span id="libro-page-num">1</span></span>
                <button id="libro-next-btn" disabled>Siguiente</button>
            </div>
            <table>
                <thead>
                    <tr>
                        <th><input type="checkbox" id="select-all-libro"></th>
                        <th>Fecha</th>
                        <th>Valor</th>
                        <th>ID Mov. Banco</th>
                        <th>Estado</th>
                    </tr>
                </thead>
                <tbody id="libro-table-body"></tbody>
            </table>
        </div>

        <div class="table-wrapper">
            <h2>Movimientos Bancarios</h2>
            <div class="search-filter-container">
                <input type="text" id="banco-search-valor" placeholder="Buscar por Valor">
                <input type="text" id="banco-search-id" placeholder="Buscar por ID">
                <label class="filter-label">
                    <input type="checkbox" id="banco-filter-conciliados"> Filtrar Punteados
                </label>
            </div>
            <div class="pagination" id="banco-pagination">
                <button id="banco-prev-btn" disabled>Anterior</button>
                <span>Página <span id="banco-page-num">1</span></span>
                <button id="banco-next-btn" disabled>Siguiente</button>
            </div>
            <table>
                <thead>
                    <tr>
                        <th><input type="checkbox" id="select-all-banco"></th>
                        <th>Fecha</th>
                        <th>Valor</th>
                        <th>ID Mov. Origen</th>
                        <th>Estado</th>
                    </tr>
                </thead>
                <tbody id="banco-table-body"></tbody>
            </table>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script>
        let allLibroData = [];
        let allBancoData = [];
        let currentLibroData = [];
        let currentBancoData = [];
        const itemsPerPage = 20;
        let libroCurrentPage = 1;
        let bancoCurrentPage = 1;

        const libroFileInput = document.getElementById('libro-file');
        const bancoFileInput = document.getElementById('banco-file');
        const autoMatchBtn = document.getElementById('auto-match-btn');
        const manualMatchBtn = document.getElementById('manual-match-btn');
        const downloadBtn = document.getElementById('download-btn');

        libroFileInput.addEventListener('change', (e) => handleFileUpload(e, 'libro'));
        bancoFileInput.addEventListener('change', (e) => handleFileUpload(e, 'banco'));
        autoMatchBtn.addEventListener('click', performAutoMatch);
        manualMatchBtn.addEventListener('click', performManualMatch);
        downloadBtn.addEventListener('click', downloadConciliation);

        // Event Listeners for Search and Filter
        document.getElementById('libro-search-valor').addEventListener('input', () => filterAndSearch('libro'));
        document.getElementById('libro-search-id').addEventListener('input', () => filterAndSearch('libro'));
        document.getElementById('libro-filter-conciliados').addEventListener('change', () => filterAndSearch('libro'));

        document.getElementById('banco-search-valor').addEventListener('input', () => filterAndSearch('banco'));
        document.getElementById('banco-search-id').addEventListener('input', () => filterAndSearch('banco'));
        document.getElementById('banco-filter-conciliados').addEventListener('change', () => filterAndSearch('banco'));

        function handleFileUpload(event, type) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const sheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[sheetName];
                const jsonData = XLSX.utils.sheet_to_json(worksheet);

                if (type === 'libro') {
                    allLibroData = jsonData.map(item => ({ ...item, estado: 'Pendiente', seleccionado: false, id: Math.random() }));
                    currentLibroData = allLibroData;
                    renderTable('libro');
                } else {
                    allBancoData = jsonData.map(item => ({ ...item, estado: 'Pendiente', seleccionado: false, id: Math.random() }));
                    currentBancoData = allBancoData;
                    renderTable('banco');
                }
                updateButtonState();
                updateMetrics();
            };
            reader.readAsArrayBuffer(file);
        }

        function updateButtonState() {
            if (allLibroData.length > 0 && allBancoData.length > 0) {
                autoMatchBtn.disabled = false;
                manualMatchBtn.disabled = false;
                downloadBtn.disabled = false;
            } else {
                autoMatchBtn.disabled = true;
                manualMatchBtn.disabled = true;
                downloadBtn.disabled = true;
            }
        }

        function renderTable(type) {
            const data = type === 'libro' ? currentLibroData : currentBancoData;
            const tableBody = document.getElementById(`${type}-table-body`);
            const pageNumSpan = document.getElementById(`${type}-page-num`);
            const prevBtn = document.getElementById(`${type}-prev-btn`);
            const nextBtn = document.getElementById(`${type}-next-btn`);
            const currentPage = type === 'libro' ? libroCurrentPage : bancoCurrentPage;

            tableBody.innerHTML = '';
            const start = (currentPage - 1) * itemsPerPage;
            const end = start + itemsPerPage;
            const paginatedData = data.slice(start, end);

            if (paginatedData.length === 0) {
                 tableBody.innerHTML = `<tr><td colspan="5" style="text-align:center; color:#999; padding:50px;">No hay datos para mostrar</td></tr>`;
                 return;
            }

            paginatedData.forEach(item => {
                const tr = document.createElement('tr');
                tr.className = getClassForEstado(item.estado);
                tr.dataset.itemId = item.id;
                
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.checked = item.estado !== 'Pendiente' && item.estado !== 'PARTIDA_CONCILIATORIA';
                checkbox.disabled = item.estado !== 'Pendiente';
                checkbox.addEventListener('change', (e) => {
                    const id = tr.dataset.itemId;
                    const mainData = type === 'libro' ? allLibroData : allBancoData;
                    const foundItem = mainData.find(d => d.id == id);
                    if(foundItem) {
                        foundItem.seleccionado = e.target.checked;
                    }
                });

                const valor = (item.Valor || item.VALOR).toLocaleString('es-CO', { style: 'currency', currency: 'COP' });
                const fecha = item.fecha || 'N/A';
                const id = type === 'libro' ? item.IdMvimientoBanco : item.IdMovimientos;
                const referencia = type === 'libro' ? item.NumeroAsiento : item.idMovimientoOrigen;

                tr.innerHTML = `
                    <td></td>
                    <td>${fecha}</td>
                    <td>${valor}</td>
                    <td>${type === 'libro' ? id : referencia}</td>
                    <td>${item.estado}</td>
                `;
                tr.querySelector('td').prepend(checkbox);
                tableBody.appendChild(tr);
            });

            pageNumSpan.textContent = currentPage;
            prevBtn.disabled = currentPage === 1;
            nextBtn.disabled = end >= data.length;
        }

        function getClassForEstado(estado) {
            switch (estado) {
                case 'MATCH_ID':
                case 'MATCH_FECHA_VALOR':
                case 'MATCH_MANUAL':
                    return 'conciliado';
                case 'PARTIDA_CONCILIATORIA':
                    return 'partida-conciliatoria';
                default:
                    return '';
            }
        }

        document.getElementById('libro-prev-btn').addEventListener('click', () => {
            if (libroCurrentPage > 1) {
                libroCurrentPage--;
                renderTable('libro');
            }
        });
        document.getElementById('libro-next-btn').addEventListener('click', () => {
            libroCurrentPage++;
            renderTable('libro');
        });

        document.getElementById('banco-prev-btn').addEventListener('click', () => {
            if (bancoCurrentPage > 1) {
                bancoCurrentPage--;
                renderTable('banco');
            }
        });
        document.getElementById('banco-next-btn').addEventListener('click', () => {
            bancoCurrentPage++;
            renderTable('banco');
        });

        function updateMetrics() {
            const totalLibro = allLibroData.reduce((sum, item) => sum + (parseFloat(item.Valor) || parseFloat(item.VALOR) || 0), 0);
            const totalBanco = allBancoData.reduce((sum, item) => sum + (parseFloat(item.Valor) || parseFloat(item.VALOR) || 0), 0);
            const totalPunteadoLibro = allLibroData.filter(item => item.estado !== 'Pendiente' && item.estado !== 'PARTIDA_CONCILIATORIA').reduce((sum, item) => sum + (parseFloat(item.Valor) || parseFloat(item.VALOR) || 0), 0);
            const totalPunteadoBanco = allBancoData.filter(item => item.estado !== 'Pendiente' && item.estado !== 'PARTIDA_CONCILIATORIA').reduce((sum, item) => sum + (parseFloat(item.Valor) || parseFloat(item.VALOR) || 0), 0);
            const partidasConciliatorias = allLibroData.filter(item => item.estado === 'PARTIDA_CONCILIATORIA').reduce((sum, item) => sum + (parseFloat(item.Valor) || parseFloat(item.VALOR) || 0), 0);
            
            const formatCurrency = (val) => val.toLocaleString('es-CO', { style: 'currency', currency: 'COP' });

            document.getElementById('total-libro-val').textContent = formatCurrency(totalLibro);
            document.getElementById('total-banco-val').textContent = formatCurrency(totalBanco);
            document.getElementById('total-punteado-val').textContent = formatCurrency(totalPunteadoLibro);
            document.getElementById('diferencia-val').textContent = formatCurrency(totalLibro - totalBanco);
            document.getElementById('partidas-val').textContent = formatCurrency(partidasConciliatorias);
        }

        function filterAndSearch(type) {
            const dataToFilter = type === 'libro' ? allLibroData : allBancoData;
            const filterConciliados = document.getElementById(`${type}-filter-conciliados`).checked;
            const searchValueValor = document.getElementById(`${type}-search-valor`).value.toLowerCase();
            const searchValueId = document.getElementById(`${type}-search-id`).value.toLowerCase();

            let filteredData = dataToFilter;

            if (filterConciliados) {
                filteredData = filteredData.filter(item => item.estado !== 'Pendiente' && item.estado !== 'PARTIDA_CONCILIATORIA');
            }

            if (searchValueValor) {
                filteredData = filteredData.filter(item => 
                    (item.Valor || item.VALOR).toString().toLowerCase().includes(searchValueValor)
                );
            }

            if (searchValueId) {
                filteredData = filteredData.filter(item => {
                    const id = type === 'libro' ? item.IdMvimientoBanco : item.IdMovimientos;
                    return id && id.toString().toLowerCase().includes(searchValueId);
                });
            }

            if (type === 'libro') {
                currentLibroData = filteredData;
                libroCurrentPage = 1;
                renderTable('libro');
            } else {
                currentBancoData = filteredData;
                bancoCurrentPage = 1;
                renderTable('banco');
            }
        }

        function performAutoMatch() {
            if (allLibroData.length === 0 || allBancoData.length === 0) {
                alert('Por favor, carga ambos archivos antes de conciliar.');
                return;
            }

            // Conciliación por ID
            allBancoData.forEach(bancoItem => {
                if (bancoItem.estado !== 'Pendiente') return;
                
                const matches = allLibroData.filter(libroItem => 
                    libroItem.estado === 'Pendiente' && 
                    libroItem.IdMvimientoBanco == bancoItem.idMovimientoOrigen &&
                    (bancoItem.idMovimientoOrigen !== 0 && bancoItem.idMovimientoOrigen !== null)
                );

                const sumLibro = matches.reduce((sum, item) => sum + (parseFloat(item.Valor) || parseFloat(item.VALOR)), 0);
                if (sumLibro > 0 && sumLibro.toFixed(2) === (parseFloat(bancoItem.Valor) || parseFloat(bancoItem.VALOR)).toFixed(2)) {
                    matches.forEach(m => m.estado = 'MATCH_ID');
                    bancoItem.estado = 'MATCH_ID';
                }
            });

            // Conciliación por Fecha y Valor
            const pendientesLibro = allLibroData.filter(item => item.estado === 'Pendiente' && (item.IdMvimientoBanco === 0 || item.IdMvimientoBanco === null));
            const pendientesBanco = allBancoData.filter(item => item.estado === 'Pendiente' && (item.idMovimientoOrigen === 0 || item.idMovimientoOrigen === null));

            pendientesBanco.forEach(bancoItem => {
                if (bancoItem.estado !== 'Pendiente') return;

                const matches = pendientesLibro.filter(libroItem => 
                    libroItem.estado === 'Pendiente' && 
                    libroItem.fecha === bancoItem.fecha &&
                    (parseFloat(libroItem.Valor) || parseFloat(libroItem.VALOR)).toFixed(2) === (parseFloat(bancoItem.Valor) || parseFloat(bancoItem.VALOR)).toFixed(2)
                );

                if (matches.length > 0) {
                    matches.forEach(m => m.estado = 'MATCH_FECHA_VALOR');
                    bancoItem.estado = 'MATCH_FECHA_VALOR';
                }
            });
            
            // Marcar restantes como partidas conciliatorias
            allLibroData.filter(item => item.estado === 'Pendiente').forEach(item => item.estado = 'PARTIDA_CONCILIATORIA');
            allBancoData.filter(item => item.estado === 'Pendiente').forEach(item => item.estado = 'PARTIDA_CONCILIATORIA');

            renderTable('libro');
            renderTable('banco');
            updateMetrics();
        }

        function performManualMatch() {
            const selectedLibro = allLibroData.filter(item => item.seleccionado);
            const selectedBanco = allBancoData.filter(item => item.seleccionado);

            if (selectedLibro.length === 0 || selectedBanco.length === 0) {
                alert('Debes seleccionar al menos un movimiento de cada tabla.');
                return;
            }

            const sumLibro = selectedLibro.reduce((sum, item) => sum + (parseFloat(item.Valor) || parseFloat(item.VALOR)), 0);
            const sumBanco = selectedBanco.reduce((sum, item) => sum + (parseFloat(item.Valor) || parseFloat(item.VALOR)), 0);

            if (sumLibro.toFixed(2) === sumBanco.toFixed(2)) {
                selectedLibro.forEach(item => {
                    item.estado = 'MATCH_MANUAL';
                    item.seleccionado = false;
                });
                selectedBanco.forEach(item => {
                    item.estado = 'MATCH_MANUAL';
                    item.seleccionado = false;
                });
                alert('Conciliación manual exitosa!');
            } else {
                alert('La suma de los valores seleccionados no coincide. Por favor, revisa los movimientos.');
            }

            // Re-render the tables to reflect the changes and clear the selections
            renderTable('libro');
            renderTable('banco');
            updateMetrics();
        }

        function downloadConciliation() {
            if (allLibroData.length === 0 || allBancoData.length === 0) {
                alert('No hay datos para descargar. Por favor, carga los archivos y realiza la conciliación.');
                return;
            }

            const getEstadoPunteado = (estado) => {
                const punteados = ['MATCH_ID', 'MATCH_FECHA_VALOR', 'MATCH_MANUAL'];
                return punteados.includes(estado) ? 'Sí' : 'No';
            };

            const libroDataForExport = allLibroData.map(item => {
                const { seleccionado, id, ...rest } = item;
                return { ...rest, Punteados: getEstadoPunteado(item.estado) };
            });

            const bancoDataForExport = allBancoData.map(item => {
                const { seleccionado, id, ...rest } = item;
                return { ...rest, Punteados: getEstadoPunteado(item.estado) };
            });

            const libroSheet = XLSX.utils.json_to_sheet(libroDataForExport);
            const bancoSheet = XLSX.utils.json_to_sheet(bancoDataForExport);

            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, libroSheet, "Libro Contable");
            XLSX.utils.book_append_sheet(wb, bancoSheet, "Movimientos Bancarios");

            const today = new Date().toISOString().slice(0, 10);
            const filename = `Consolidado_Conciliacion_${today}.xlsx`;

            XLSX.writeFile(wb, filename);
        }
    </script>
</body>
</html>